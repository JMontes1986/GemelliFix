rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla global para Administradores: Acceso total a todo.
    // Esta es la regla principal que desbloquea la vista de administrador.
    match /{document=**} {
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Administrador';
    }

    // Reglas para la colección 'users'
    match /users/{userId} {
      // Los usuarios pueden leer y actualizar su propio perfil.
      allow read, update: if request.auth.uid == userId;
      // Solo los administradores pueden crear o eliminar usuarios. (Heredado de la regla global)
    }
    
    // Reglas para la colección 'tickets'
    match /tickets/{ticketId} {
        // Permitir creación a cualquier usuario autenticado
        allow create: if request.auth != null;

        // Permitir lectura si:
        // 1. Eres el solicitante.
        // 2. Eres de Servicios Generales.
        // 3. Eres Administrador (cubierto por la regla global).
        allow read: if request.auth.uid == resource.data.requesterId 
                        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Servicios Generales';

        // Permitir actualización si:
        // 1. Eres de Servicios Generales.
        // 2. Eres Administrador (cubierto por la regla global).
        allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Servicios Generales';
    }

    // Reglas para la colección 'notifications'
    match /notifications/{notificationId} {
      // Un usuario puede leer y actualizar (marcar como leída) sus propias notificaciones.
      allow read, update: if request.auth.uid == resource.data.userId;
      // La creación de notificaciones se maneja desde el backend (servidor o funciones).
    }

    // Reglas para eventos del calendario
    match /scheduleEvents/{eventId} {
      // Solo el personal de Servicios Generales y Administradores pueden ver/crear eventos.
      allow read, create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Servicios Generales';
    }

    // Reglas para los logs
    match /logs/{logId} {
      // Los logs son de solo lectura para los Administradores. La creación se maneja desde el backend.
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Administrador';
    }

    // Reglas para datos maestros (zonas, sitios)
    match /zones/{zoneId} {
        // Lectura para usuarios autenticados, escritura solo para admins.
        allow read: if request.auth != null;
    }
    match /sites/{siteId} {
        allow read: if request.auth != null;
    }
  }
}
