
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // == Funciones de ayuda reutilizables ==

    // Devuelve verdadero si el usuario que realiza la solicitud tiene el rol especificado.
    function isUserInRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Devuelve verdadero si el usuario que realiza la solicitud es el creador del ticket.
    function isOwner(docData) {
        return request.auth.uid == docData.requesterId;
    }

    // Devuelve verdadero si el usuario que realiza la solicitud está en la lista de asignados del ticket.
    function isAssigned(docData) {
        return request.auth.uid in docData.assignedToIds;
    }

    // == Reglas para la colección 'users' ==
    match /users/{userId} {
      // Cualquiera puede leer perfiles de usuario (para ver nombres, avatares, etc.).
      allow read: if request.auth != null;
      // Un usuario solo puede editar su propio perfil.
      allow write: if request.auth.uid == userId;
    }

    // == Reglas para la colección 'tickets' ==
    match /tickets/{ticketId} {
      // Cualquier usuario autenticado puede crear un ticket.
      allow create: if request.auth != null;

      // Solo los administradores pueden listar todos los tickets.
      allow list: if isUserInRole('Administrador');

      // Se puede leer un ticket si eres el dueño, estás asignado o eres administrador.
      allow read: if request.auth != null && 
                  (isOwner(resource.data) || isAssigned(resource.data) || isUserInRole('Administrador'));
      
      // Se puede actualizar un ticket si eres el dueño (con limitaciones), estás asignado o eres administrador.
      allow update: if request.auth != null && 
                     (isAssigned(resource.data) || isUserInRole('Administrador'));

      // Nadie puede eliminar tickets para mantener la integridad del historial.
      allow delete: if false; 
    }

    // == Reglas para la colección 'notifications' ==
    match /notifications/{notificationId} {
        // Un usuario solo puede leer sus propias notificaciones.
        allow read: if request.auth != null && request.auth.uid == resource.data.userId;
        // El sistema crea notificaciones, por lo que se permite la escritura a usuarios autenticados.
        allow create: if request.auth != null;
        // Un usuario puede actualizar (marcar como leída) su propia notificación.
        allow update: if request.auth != null && request.auth.uid == resource.data.userId;
        // No se permite eliminar notificaciones.
        allow delete: if false;
    }

    // == Reglas para la colección 'logs' ==
    match /logs/{logId} {
        // El sistema crea logs en nombre de los usuarios.
        allow create: if request.auth != null;
        // Solo los administradores pueden leer, actualizar o borrar logs.
        allow read, update, delete: if isUserInRole('Administrador');
    }

    // == Reglas para la colección de diagnóstico ==
    match /diagnosis_logs/{logId} {
        // La prueba de diagnóstico puede ser creada por cualquier usuario autenticado.
        allow create: if request.auth != null;
        // Solo los administradores pueden ver los resultados de los diagnósticos.
        allow read, update, delete: if isUserInRole('Administrador');
    }
  }
}
