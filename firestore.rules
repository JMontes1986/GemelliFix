rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuth() && getUserData().role == 'Administrador';
    }

    function isSST() {
      return isAuth() && getUserData().role == 'SST';
    }

    function isServices() {
        return isAuth() && getUserData().role == 'Servicios Generales';
    }

    // USER-RELATED RULES
    match /users/{userId} {
      allow read: if isAuth(); // Anyone can read user profiles for display names, etc.
      allow create: if isAuth() && request.resource.data.uid == request.auth.uid; // Can create their own user document
      allow update: if isAdmin() || isUser(userId); // Admins can update any user, users can update their own
    }
    
    // DATA MASTER RULES (Zones, Sites, Categories)
    match /zones/{zoneId} {
        allow read: if isAuth();
        allow write: if isAdmin();
    }
    
    match /sites/{siteId} {
        allow read: if isAuth();
        allow write: if isAdmin();
    }
    
    match /categories/{categoryId} {
        allow read: if isAuth();
        allow write: if isAdmin();
    }
    
    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read, update: if isAuth() && getUserData().id == resource.data.userId;
      allow create: if isAuth(); // Allow server-side processes to create notifications for users
    }
    
    // LOGS
    match /logs/{logId} {
        allow read: if isAdmin();
        allow create: if isAuth();
    }

    // SCHEDULE EVENTS
    match /scheduleEvents/{eventId} {
        allow read: if isAuth(); // Anyone authenticated can read calendar events
        allow create, update, delete: if isAuth() && (isAdmin() || isServices()); // Only Admins or Service personnel can modify calendar
    }

    // REQUISITIONS
    match /requisitions/{requisitionId} {
        allow read, list: if isAdmin();
        allow create, update: if isAdmin();
    }

    // TICKET RULES
    match /tickets/{ticketId} {
      // CREATE: Anyone authenticated can create a ticket.
      allow create: if isAuth();

      // READ: 
      // - The user who requested it can read it.
      // - The admin can read it.
      // - The SST role can read it.
      // - Any assigned technician can read it.
      allow read: if isAuth() && 
                    (resource.data.requesterId == request.auth.uid ||
                     isAdmin() || isSST() || 
                     request.auth.uid in resource.data.assignedToIds);

      // UPDATE:
      // - Admins can update anything.
      // - Assigned technicians can update status, evidence, etc.
      allow update: if isAuth() && (isAdmin() || request.auth.uid in resource.data.assignedToIds);
    }
  }
}
