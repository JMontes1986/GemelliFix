
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para la colección 'users'
    match /users/{userId} {
      // Los administradores tienen acceso total a todos los perfiles de usuario.
      allow read, write: if request.auth.token.admin == true;
      
      // Los usuarios no administradores solo pueden leer y actualizar su propio perfil.
      allow read, update: if request.auth.uid == userId;
    }

    // Reglas para la colección 'tickets'
    match /tickets/{ticketId} {
      // Cualquier usuario autenticado puede crear un ticket.
      allow create: if request.auth != null;

      // Los administradores pueden leer y actualizar cualquier ticket.
      // Los usuarios asignados (Servicios Generales) pueden leer y actualizar el ticket.
      // El usuario que creó el ticket puede leerlo.
      allow read, update: if request.auth.token.admin == true || request.auth.uid in resource.data.assignedToIds || request.auth.uid == resource.data.requesterId;
    }

    // Reglas para la colección de logs del sistema
    match /logs/{logId} {
      // Solo los administradores pueden leer los logs.
      allow read: if request.auth.token.admin == true;
      // Nadie puede modificar o eliminar logs, pero el sistema puede crearlos.
      // La creación se maneja desde el backend (Cloud Functions o server-side logic).
      allow write: if false; 
      allow create: if true; // Permitir la creación desde el backend
    }
    
    // Reglas para las notificaciones
    match /notifications/{notificationId} {
      // Un usuario solo puede leer o actualizar (marcar como leída) sus propias notificaciones.
      allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
      // La creación de notificaciones se maneja desde el backend.
      allow create: if true;
    }

    // Reglas para el calendario de eventos
    match /scheduleEvents/{eventId} {
      // Cualquier usuario autenticado puede leer los eventos para ver el calendario.
      allow read: if request.auth != null;
      // Solo los administradores pueden crear, actualizar o eliminar eventos.
      allow write: if request.auth.token.admin == true;
    }

    // Reglas para colecciones de configuración (zonas, sitios, etc.)
    match /zones/{zoneId} {
        // Solo los administradores pueden gestionar las zonas.
        allow read, write: if request.auth.token.admin == true;
    }

     match /sites/{siteId} {
        // Solo los administradores pueden gestionar los sitios.
        allow read, write: if request.auth.token.admin == true;
    }

    // Reglas para logs de diagnóstico (solo para pruebas)
    match /diagnosis_logs/{logId} {
        // Permite a cualquier usuario autenticado escribir para las pruebas de diagnóstico.
        allow write: if request.auth != null;
    }

  }
}
