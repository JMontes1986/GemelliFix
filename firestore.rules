
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Admin role is checked via custom claims set by a Cloud Function.
      return isAuth() && request.auth.token.role == 'Administrador';
    }
    
    function isSST() {
      return isAuth() && request.auth.token.role == 'SST';
    }
    
    function isServiceUser() {
        return isAuth() && request.auth.token.role == 'Servicios Generales';
    }

    // USERS
    match /users/{userId} {
      allow read: if isAuth(); // Anyone logged in can read user profiles (for names, avatars, etc.)
      allow create: if isAuth() && !exists(/databases/$(database)/documents/users/$(request.auth.uid)); // Allow a user to create their own doc if it doesn't exist
      allow update: if isAdmin() || request.auth.uid == userId; // Admins or the user themselves can update.
    }
    
    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read, update, create: if isAuth(); // Users can manage their own notifications, simplistic rule
    }
    
    // LOGS
    match /logs/{logId} {
        // Only Admins and SST can read logs for auditing purposes.
      allow read: if isAdmin() || isSST();
      // Only authenticated users can create logs (client-side logging).
      allow create: if isAuth();
    }

    // TICKETS
    match /tickets/{ticketId} {
      // Allow read access if the user is an admin, SST, or the original requester.
      allow read: if isAdmin() || isSST() || (isAuth() && request.auth.uid == resource.data.requesterId);
      allow create: if isAuth(); // Any authenticated user can create a ticket.
      allow update: if isAdmin() || (isServiceUser() && request.auth.uid in resource.data.assignedToIds); // Admins or assigned technicians can update.
    }
    
    // MASTER DATA (Categories, Zones, Sites)
    match /{collectionName}/{docId} where collectionName in ['categories', 'zones', 'sites'] {
        allow read: if isAuth(); // All authenticated users can read master data
        allow write: if isAdmin(); // Only admins can modify master data
    }
    
    // SCHEDULE EVENTS
    match /scheduleEvents/{eventId} {
      allow read: if isAuth(); // All authenticated users can see calendar events
      // Only Admins or the assigned service user can create/update/delete events
      allow write: if isAdmin() || (isServiceUser() && request.auth.uid == request.resource.data.technicianId);
    }
  }
}
