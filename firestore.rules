rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check user role from a custom claim
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      return getUserRole() == 'admin';
    }

    // Helper function to check if the user is a technician
    function isTech() {
        return getUserRole() == 'tech';
    }

    // Helper function to check if the user is a requester
    function isRequester() {
        return getUserRole() == 'requester';
    }

    // A user can see their own user data
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid != null; // Any authenticated user can create their profile
      allow update: if request.auth.uid == userId || isAdmin();
    }
    
    // Zones and Sites can be read by anyone, but only created/edited by admins
    match /zones/{zoneId} {
       allow read: if request.auth.uid != null; // Any authenticated user can read
       allow write: if isAdmin();
    }

    match /sites/{siteId} {
       allow read: if request.auth.uid != null; // Any authenticated user can read
       allow write: if isAdmin();
    }

    // Tickets have more complex rules
    match /tickets/{ticketId} {
      // READ:
      // - Admins can read everything.
      // - Requesters can read their own tickets.
      // - Techs can read tickets assigned to them or in their assigned zones (future implementation).
      allow read: if isAdmin() || 
                    (isRequester() && resource.data.requesterId == request.auth.uid) ||
                    (isTech() && resource.data.assignedToId == request.auth.uid);

      // CREATE:
      // - Requesters and Admins can create tickets.
      // - Ensure the requesterId is set to the user's own UID.
      allow create: if (isRequester() || isAdmin()) && request.resource.data.requesterId == request.auth.uid;
      
      // UPDATE:
      // - Admins can edit anything.
      // - Requesters can only edit their own tickets if they are still 'Abierto'.
      // - Techs can update status and add attachments, but not change core details or close.
      allow update: if isAdmin() ||
                      (isRequester() && resource.data.requesterId == request.auth.uid && resource.data.status == 'Abierto') ||
                      (isTech() && resource.data.assignedToId == request.auth.uid && !('priority' in request.resource.data)); // Techs can't change priority
    }
    
  }
}